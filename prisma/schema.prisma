generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                @id @default(uuid())
  email                  String                @unique
  password               String
  name                   String?
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  todoItems              TodoItem[]
  complianceSubmissions  ComplianceSubmission[]
}

model TodoItem {
  id          String    @id @default(uuid())
  title       String
  description String?
  priority    String    @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  status      String    @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED
  itemType    String    @default("TASK") // TASK (user-created), FLAGGED_ITEM (system-suggested)
  dueDate     DateTime?
  dismissedAt DateTime? // When a FLAGGED_ITEM was dismissed
  deferredUntil DateTime? // When to show a deferred FLAGGED_ITEM again
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Link to resources or submissions
  relatedSubmissionId String?
  relatedSubmission   ComplianceSubmission? @relation(fields: [relatedSubmissionId], references: [id])
}

model ComplianceScope {
  id                    String                 @id @default(uuid())
  code                  String                 @unique // e.g., "CA", "NY", "US", "NYC"
  name                  String                 // e.g., "California", "New York", "Federal", "New York City"
  scopeType             String                 // "STATE", "FEDERAL", "CITY", "COUNTY"
  isActive              Boolean                @default(true)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  complianceAccountTypes ComplianceAccountType[]
  stateResources        StateResource[]
}

model ComplianceAccountType {
  id                    String                 @id @default(uuid())
  name                  String                 // e.g., "Employer Payroll Tax Account", "Sales Tax Permit"
  scopeId               String                 // Reference to ComplianceScope
  scope                 ComplianceScope        @relation(fields: [scopeId], references: [id])
  agency                String                 // e.g., "Department of Revenue", "Secretary of State"
  description           String?                // Description of this account type
  requiredFields        String?                // JSON array of required field names
  defaultDuration       String?                // Default duration/frequency (e.g., "Annual", "Biennial", "Quarterly")
  isActive              Boolean                @default(true)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  complianceSubmissions ComplianceSubmission[]
  
  @@unique([name, scopeId, agency])
}

model ComplianceSubmission {
  id                      String                  @id @default(uuid())
  complianceType          String                  // e.g., "SOS Registration", "Tax Filing", etc.
  state                   String                  // Two-letter state code (kept for backward compatibility)
  stateAgency             String                  // e.g., "Secretary of State", "Department of Revenue" (kept for backward compatibility)
  
  // Compliance Account Type relationship
  complianceAccountTypeId String?
  complianceAccountType   ComplianceAccountType?  @relation(fields: [complianceAccountTypeId], references: [id])
  
  entityName              String?                 // Company/entity name
  registrationNumber      String?
  submittedOn             DateTime?               // Date when the submission was made
  filingDate              DateTime?
  expirationDate          DateTime?
  duration                String?                 // Filing frequency/duration (e.g., "Annual", "Biennial", "Quarterly")
  status                  String                  @default("ACTIVE") // ACTIVE, EXPIRED, PENDING, OBSOLETE, USER_DEFERRED, USER_DISMISSED
  deferDuration           Int?                    // Number of days the submission was deferred (for USER_DEFERRED status)
  
  // Links (not storing actual sensitive data)
  filingStorageLink       String?                 // Link to Sharepoint, Google Drive, etc.
  compliancePageLink      String?                 // Link to state compliance portal
  passwordManagerLink     String?                 // Link to password manager entry
  
  notes                   String?
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  userId                  String
  user                    User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  todoItems               TodoItem[]
}

model StateResource {
  id                String          @id @default(uuid())
  scopeId           String          // Reference to ComplianceScope
  scope             ComplianceScope @relation(fields: [scopeId], references: [id])
  complianceType    String          // Type of compliance submission
  title             String
  description       String          // Detailed guide/process description
  requiredDocuments String?         // JSON array of required documents
  filingFrequency   String?         // e.g., "Annual", "Biennial"
  fees              String?
  portalLink        String?
  additionalNotes   String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
}

model NexusData {
  id              String   @id @default(uuid())
  userId          String
  fileName        String
  fileType        String   // e.g., "payroll", "census"
  uploadDate      DateTime @default(now())
  analysisResults String   // JSON string containing nexus analysis
  recommendations String?  // JSON string containing recommended actions
  processed       Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
